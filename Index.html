<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {// ==========================================
// ARQUIVO: Code.gs (Backend)
// ==========================================

// Configuração
var SPREADSHEET_ID = '15ZflxC82kDMcK8k4CbZQmX_fO9wDUl86tGYlJ3IMiT4';
var ABA_CONSOLIDADO = 'Consolidado';

// Colunas (0-indexed)
// Confirmed mapping: L is 11 (A=0, ..., L=11)
var COL = {
  AGENCIA: 0,      // A
  CAMPANHA: 2,     // C
  NF: 5,           // F
  VEICULO: 9,      // J
  TIPO_MIDIA: 11,  // L - Tipo de Mídia
  STATUS_PAG: 12,  // M
  EXECUTOR: 13,    // N
  ATESTO: 18,      // S
  CONTROLE: 19,    // T
  DATA_PAGO: 20,   // U
  VALOR: 27        // AB
};

// Status exatos na planilha
var STATUS = {
  EM_PROCESSO: 'em processo de pagamento',
  ATESTADA: 'atestada',
  INCONFORMIDADE: 'com inconformidade', 
  PAGA: 'paga'
};

// --- PERSISTENCE HELPERS ---
function getStoredData_() {
  var props = PropertiesService.getScriptProperties();
  var data = props.getProperty('DASHBOARD_DATA');
  return data ? JSON.parse(data) : {};
}

function saveStoredData_(data) {
  var props = PropertiesService.getScriptProperties();
  props.setProperty('DASHBOARD_DATA', JSON.stringify(data));
}

function getKey_(row) {
  // Key format: AGENCIA|CAMPANHA|CONTROLE (fallback to SEM_CONTROLE)
  var controle = String(row[COL.CONTROLE] || 'SEM_CONTROLE');
  return row[COL.AGENCIA] + '|' + row[COL.CAMPANHA] + '|' + controle;
}

// --- PUBLIC FUNCTIONS ---

function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
    .setTitle('Controle de Pagamentos')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function getSheet_() {
  return SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(ABA_CONSOLIDADO);
}

function getAllData_() {
  var sheet = getSheet_();
  var data = sheet.getDataRange().getValues();
  return data.slice(1); // Remove header
}

function formatDateForJSON_(date) {
  if (!date) return null;
  if (date instanceof Date) {
    return date.toISOString();
  }
  return null;
}

// Salvar Status (chamado pelo Frontend)
function saveStatus(key, newStatus) {
  var stored = getStoredData_();
  if (!stored[key]) stored[key] = {};
  
  stored[key].statusPag = newStatus;
  saveStoredData_(stored);
  return true;
}

// Salvar Observação (chamado pelo Frontend)
function saveObs(key, newObs) {
  var stored = getStoredData_();
  if (!stored[key]) stored[key] = {};
  
  stored[key].obs = newObs;
  saveStoredData_(stored);
  return true;
}

function getEmProcesso() {
  var data = getAllData_();
  var stored = getStoredData_();
  var grupos = {};
  
  data.forEach(function(row) {
    var status = String(row[COL.STATUS_PAG] || '').toLowerCase().trim();
    
    if (status === STATUS.EM_PROCESSO) {
      var key = getKey_(row);
      
      if (!grupos[key]) {
        // Load stored props or defaults
        var saved = stored[key] || {};
        
        grupos[key] = {
          agencia: row[COL.AGENCIA],
          campanha: row[COL.CAMPANHA],
          controle: String(row[COL.CONTROLE] || 'SEM_CONTROLE'),
          qtd: 0,
          valor: 0,
          dataAtesto: null,
          obs: saved.obs || '',           // Load saved obs
          statusPag: saved.statusPag || 'montando' // Load saved status
        };
      }
      
      grupos[key].qtd++;
      grupos[key].valor += parseFloat(row[COL.VALOR]) || 0;
      
      var dataAtesto = row[COL.ATESTO];
      if (dataAtesto && (!grupos[key].dataAtesto || dataAtesto < grupos[key].dataAtesto)) {
        grupos[key].dataAtesto = formatDateForJSON_(dataAtesto);
      }
    }
  });
  
  var result = Object.values(grupos);
  result.sort(function(a, b) {
    if (!a.dataAtesto) return 1;
    if (!b.dataAtesto) return -1;
    return new Date(a.dataAtesto) - new Date(b.dataAtesto);
  });
  
  return result;
}

function getAtestadas() {
  var data = getAllData_();
  var stored = getStoredData_();
  var grupos = {};
  
  data.forEach(function(row) {
    var status = String(row[COL.STATUS_PAG] || '').toLowerCase().trim();
    var isAtestada = status.indexOf('atestada') !== -1;
    var isInconformidade = status.indexOf('inconformidade') !== -1;
    
    if (isAtestada || isInconformidade) {
      // For Linkage, we usually key by Agencia|Campanha for grouping
      // BUT for Observation, we likely want it per row or per group?
      // The user UI groups by Agencia|Campanha.
      // We will Key by AGENCIA|CAMPANHA for the Group.
      var groupKey = row[COL.AGENCIA] + '|' + row[COL.CAMPANHA];
      
      if (!grupos[groupKey]) {
        // We use a simplified key for Obs on this group level if needed
        // Or if the user edits Obs on the group line, we save it under the group key.
        var saved = stored[groupKey] || {};
        
        grupos[groupKey] = {
          agencia: row[COL.AGENCIA],
          campanha: row[COL.CAMPANHA],
          qtdAtestada: 0,
          valorAtestado: 0,
          qtdPendente: 0,
          valorPendente: 0,
          pendentes: [],
          obs: saved.obs || '' // Load saved obs for this group
        };
      }
      
      var valor = parseFloat(row[COL.VALOR]) || 0;
      
      if (isAtestada && !isInconformidade) {
        grupos[groupKey].qtdAtestada++;
        grupos[groupKey].valorAtestado += valor;
      }
      
      if (isInconformidade) {
        grupos[groupKey].qtdPendente++;
        grupos[groupKey].valorPendente += valor;
        grupos[groupKey].pendentes.push({
          nf: row[COL.NF],
          veiculo: row[COL.VEICULO],
          executor: row[COL.EXECUTOR],
          tipoMidia: row[COL.TIPO_MIDIA], // Include Media Type
          tipo: 'Inconformidade',
          valor: valor
        });
      }
    }
  });
  
  return Object.values(grupos);
}

function getUltimasPagas() {
  var data = getAllData_();
  var grupos = {};
  
  var hoje = new Date();
  var limite = new Date(hoje.getTime() - 30 * 24 * 60 * 60 * 1000);
  
  data.forEach(function(row) {
    var status = String(row[COL.STATUS_PAG] || '').toLowerCase().trim();
    var dataPago = row[COL.DATA_PAGO];
    
    if (status === STATUS.PAGA && dataPago && dataPago >= limite) {
      var key = getKey_(row);
      
      if (!grupos[key]) {
        grupos[key] = {
          agencia: row[COL.AGENCIA],
          campanha: row[COL.CAMPANHA],
          controle: String(row[COL.CONTROLE] || 'SEM_CONTROLE'),
          qtd: 0,
          valor: 0,
          dataPago: formatDateForJSON_(dataPago)
        };
      }
      
      grupos[key].qtd++;
      grupos[key].valor += parseFloat(row[COL.VALOR]) || 0;
      
      if (dataPago > new Date(grupos[key].dataPago)) {
        grupos[key].dataPago = formatDateForJSON_(dataPago);
      }
    }
  });
  
  var result = Object.values(grupos);
  result.sort(function(a, b) {
    return new Date(b.dataPago) - new Date(a.dataPago);
  });
  
  return result;
}

function getDados() {
  return {
    emProcesso: getEmProcesso(),
    atestadas: getAtestadas(),
    pagas: getUltimasPagas()
  };
}

      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: hsl(220, 20%, 97%);
      color: hsl(220, 25%, 25%);
      padding: 20px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .header-badge {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 12px 24px;
      background: white;
      border-radius: 50px;
      border: 1px solid hsl(220, 15%, 90%);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .header-icon {
      width: 24px;
      height: 24px;
      color: hsl(252, 85%, 60%);
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: hsl(220, 25%, 25%);
    }

    /* Section */
    .section {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      border: 1px solid hsl(220, 15%, 92%);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid hsl(220, 15%, 94%);
    }

    /* PAGAS Header Left Aligned */
    .section.pagas .section-header {
      justify-content: space-between;
    }

    /* PAGAS Table Headers Centered */
    .section.pagas th {
      text-align: center;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1rem;
      font-weight: 600;
      color: hsl(220, 25%, 25%);
    }

    .section-title .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .section.processo .dot {
      background: hsl(38, 95%, 55%);
    }

    .section.atestadas .dot {
      background: hsl(142, 70%, 45%);
    }

    .section.pagas .dot {
      background: hsl(217, 90%, 60%);
    }

    .section.gerador .dot {
      background: hsl(252, 85%, 60%);
    }

    .section-count {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .count-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .count-badge.blue {
      background: hsl(217, 90%, 95%);
      color: hsl(217, 90%, 45%);
    }

    .count-badge.red {
      background: hsl(0, 75%, 95%);
      color: hsl(0, 75%, 45%);
    }

    .count-badge.gray {
      background: hsl(220, 15%, 96%);
      color: hsl(220, 10%, 50%);
    }

    /* Gerador Card - Portal Style */
    .gerador-card {
      background: white;
      border: 1px solid hsl(220, 15%, 90%);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 24px;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .gerador-card:hover {
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.08);
      border-color: hsl(38, 95%, 55%);
      transform: translateY(-2px);
    }

    .gerador-card.expanded {
      cursor: default;
    }

    .gerador-card.expanded:hover {
      transform: none;
    }


    .gerador-card-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: hsl(38, 95%, 92%);
      color: hsl(38, 95%, 55%);
      margin-right: 10px;
    }

    .gerador-card-icon svg {
      width: 16px;
      height: 16px;
    }

    .gerador-card-header {
      display: flex;
      flex-direction: row;
      align-items: center;
      text-align: left;
    }

    /* Cards Row - Stacked Layout */
    .cards-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
      margin-bottom: 24px;
    }

    /* Link Card - Unified Style */
    .link-card {
      background: white;
      border: 1px solid hsl(220, 15%, 90%);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .link-card:hover {
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.08);
      border-color: hsl(270, 70%, 55%);
      transform: translateY(-2px);
    }

    .link-card.expanded {
      cursor: default;
      grid-column: 1 / -1;
    }

    .link-card.expanded:hover {
      transform: none;
    }

    .link-card-header {
      display: flex;
      align-items: center;
    }

    .link-card-icon {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: hsl(270, 70%, 92%);
      color: hsl(270, 70%, 55%);
      margin-right: 10px;
    }

    .link-card-icon svg {
      width: 16px;
      height: 16px;
    }

    .link-card-title {
      font-size: 1rem;
      font-weight: 500;
      color: hsl(220, 25%, 25%);
    }

    .link-card-content {
      display: none;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid hsl(220, 15%, 94%);
      animation: fadeIn 0.3s ease-out;
    }

    .link-card-content.show {
      display: block;
    }

    /* Iframe Container */
    .iframe-container {
      width: 100%;
      border-radius: 8px;
      overflow: hidden;
      background: hsl(220, 20%, 98%);
      border: 1px solid hsl(220, 15%, 90%);
      min-height: 400px;
      position: relative;
    }

    .iframe-container iframe {
      width: 100%;
      height: 600px;
      border: none;
    }

    .iframe-loading {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: hsl(220, 20%, 98%);
    }
      height: 200px;
      color: hsl(220, 10%, 55%);
    }

    .iframe-loading .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid hsl(220, 15%, 90%);
      border-top-color: hsl(270, 70%, 55%);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }

    .gerador-card-title {
      font-size: 1.1rem;
      font-weight: 500;
      color: hsl(220, 25%, 25%);
      margin-bottom: 0.5rem;
    }

    .gerador-card-description {
      font-size: 0.875rem;
      color: hsl(220, 15%, 50%);
      line-height: 1.5;
    }

    .gerador-input-wrapper {
      margin-top: 1.25rem;
      display: flex;
      justify-content: center;
    }

    .gerador-input {
      width: 100%;
      max-width: 320px;
      padding: 12px 16px;
      border: 1px solid hsl(220, 15%, 90%);
      border-radius: 8px;
      font-size: 0.9rem;
      font-family: inherit;
      background: hsl(220, 20%, 98%);
      transition: all 0.2s;
      text-align: center;
    }

    .gerador-input:focus {
      outline: none;
      border-color: hsl(38, 95%, 55%);
      background: white;
      box-shadow: 0 0 0 3px hsla(38, 95%, 55%, 0.15);
    }

    .gerador-input::placeholder {
      color: hsl(220, 10%, 60%);
    }

    .gerador-content {
      display: none;
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid hsl(220, 15%, 94%);
      animation: fadeIn 0.3s ease-out;
    }

    .gerador-content.show {
      display: block;
    }

    .gerador-result {
      background: hsl(38, 95%, 97%);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .gerador-result-title {
      font-weight: 600;
      color: hsl(220, 25%, 25%);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .gerador-result-title svg {
      width: 18px;
      height: 18px;
      color: hsl(38, 95%, 55%);
    }

    .gerador-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: hsl(38, 95%, 55%);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    .gerador-link:hover {
      background: hsl(38, 95%, 50%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px hsla(38, 95%, 50%, 0.35);
    }

    .gerador-link svg {
      width: 16px;
      height: 16px;
    }

    /* Table */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      background: hsl(220, 20%, 97%);
      font-weight: 600;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: hsl(220, 10%, 50%);
      border-bottom: 2px solid hsl(220, 15%, 92%);
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid hsl(220, 15%, 95%);
      vertical-align: top;
    }

    tr:hover td {
      background: hsl(220, 20%, 98%);
    }

    tr:last-child td {
      border-bottom: none;
    }

    .agencia {
      font-weight: 600;
      color: hsl(252, 85%, 55%);
    }

    .campanha {
      color: hsl(220, 25%, 35%);
    }

    .controle {
      font-family: 'SF Mono', Consolas, monospace;
      font-size: 0.8rem;
      background: hsl(220, 15%, 96%);
      padding: 4px 8px;
      border-radius: 4px;
      color: hsl(220, 25%, 40%);
    }

    .qtd {
      text-align: center;
      font-weight: 600;
    }

    .qtd-sub {
      font-size: 0.75rem;
      color: hsl(0, 75%, 50%);
      font-weight: 500;
      margin-top: 4px;
    }

    .valor {
      font-weight: 700;
      color: hsl(142, 70%, 40%);
      white-space: nowrap;
    }

    .valor-sub {
      font-size: 0.75rem;
      color: hsl(0, 75%, 50%);
      font-weight: 500;
      margin-top: 4px;
    }

    .data {
      white-space: nowrap;
    }

    .data-dia {
      font-size: 0.7rem;
      color: hsl(220, 10%, 55%);
      display: block;
      margin-top: 2px;
    }

    /* Pendentes cell */
    .pendentes-cell {
      font-size: 0.75rem;
    }

    .pendente-item {
      background: hsl(0, 75%, 97%);
      border: 1px solid hsl(0, 75%, 90%);
      border-radius: 6px;
      padding: 6px 8px;
      margin-bottom: 4px;
      color: hsl(0, 75%, 40%);
    }

    .pendente-item:last-child {
      margin-bottom: 0;
    }

    .pendente-tipo {
      font-weight: 600;
      color: hsl(0, 75%, 45%);
      display: block;
      margin-bottom: 2px;
    }

    .pendente-info {
      color: hsl(0, 50%, 35%);
      line-height: 1.4;
    }

    /* TIPO MIDIA COLORS */
    .tipo-midia-av {
      color: hsl(270, 70%, 50%);
      /* Roxo */
      font-weight: 700;
    }

    .tipo-midia-calia {
      color: hsl(30, 95%, 50%);
      /* Laranja */
      font-weight: 700;
    }

    .tipo-midia-ebm {
      color: hsl(220, 10%, 40%);
      /* Cinza Escuro */
      font-weight: 700;
    }

    /* Input Obs */
    .obs-input {
      width: 100%;
      min-width: 120px;
      padding: 8px 12px;
      border: 1px solid hsl(220, 15%, 90%);
      border-radius: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      background: hsl(220, 20%, 98%);
      transition: all 0.2s;
    }

    .obs-input:focus {
      outline: none;
      border-color: hsl(252, 85%, 60%);
      background: white;
      box-shadow: 0 0 0 3px hsla(252, 85%, 60%, 0.1);
    }

    /* Select Status */
    .status-select {
      padding: 8px 12px;
      border: 1px solid hsl(220, 15%, 90%);
      border-radius: 6px;
      font-size: 0.8rem;
      font-family: inherit;
      background: white;
      cursor: pointer;
      min-width: 140px;
      transition: all 0.2s;
    }

    .status-select:focus {
      outline: none;
      border-color: hsl(252, 85%, 60%);
      box-shadow: 0 0 0 3px hsla(252, 85%, 60%, 0.1);
    }

    .status-select.montando {
      background: hsl(38, 95%, 95%);
      border-color: hsl(38, 95%, 75%);
    }

    .status-select.aguardando {
      background: hsl(270, 70%, 95%);
      border-color: hsl(270, 70%, 75%);
    }

    .status-select.dicom {
      background: hsl(217, 90%, 95%);
      border-color: hsl(217, 90%, 75%);
    }

    .status-select.daf {
      background: hsl(185, 85%, 93%);
      border-color: hsl(185, 85%, 65%);
    }

    .status-select.ob {
      background: hsl(142, 70%, 93%);
      border-color: hsl(142, 70%, 65%);
    }

    .status-select.enviado {
      background: hsl(142, 70%, 90%);
      border-color: hsl(142, 70%, 55%);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn svg {
      width: 14px;
      height: 14px;
    }

    .btn-primary {
      background: hsl(252, 85%, 60%);
      color: white;
    }

    .btn-primary:hover {
      background: hsl(252, 85%, 55%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px hsla(252, 85%, 50%, 0.3);
    }

    .btn-secondary {
      background: hsl(220, 15%, 95%);
      color: hsl(220, 25%, 35%);
    }

    .btn-secondary:hover {
      background: hsl(220, 15%, 90%);
    }

    .btn-success {
      background: hsl(142, 70%, 45%);
      color: white;
    }

    .btn-success:hover {
      background: hsl(142, 70%, 40%);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px hsla(142, 70%, 45%, 0.3);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: hsl(220, 10%, 55%);
    }

    .empty-state svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.4;
    }

    .empty-state p {
      font-size: 0.9rem;
    }

    /* Loading */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
      gap: 16px;
    }

    .loading.show {
      display: flex;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid hsl(220, 15%, 90%);
      border-top-color: hsl(252, 85%, 60%);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      font-size: 0.9rem;
      color: hsl(220, 10%, 50%);
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Error */
    #error {
      display: none;
      background: hsla(0, 75%, 55%, 0.1);
      color: hsl(0, 75%, 45%);
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 16px;
      text-align: center;
      border: 1px solid hsla(0, 75%, 55%, 0.2);
    }

    #error.show {
      display: block;
    }

    /* Diagnóstico */
    #diagnostico {
      display: none;
      background: hsl(220, 20%, 97%);
      color: hsl(220, 25%, 25%);
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 24px;
      border: 1px solid hsl(220, 15%, 92%);
    }

    #diagnostico.show {
      display: block;
    }

    #diagnostico .diag-title {
      font-weight: 600;
      color: hsl(220, 25%, 25%);
    }

    #diagnostico pre {
      margin-top: 10px;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.8rem;
      color: hsl(220, 15%, 35%);
    }

    /* Summary Row */
    .summary-row {
      background: hsl(220, 20%, 97%) !important;
      font-weight: 600;
    }

    .summary-row td {
      border-top: 2px solid hsl(220, 15%, 90%);
    }

    /* Pagas table centered */
    .section.pagas td {
      text-align: center;
      vertical-align: middle;
    }

    .section.pagas .controle {
      display: inline-block;
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .section {
      animation: fadeIn 0.4s ease-out;
    }

    /* Alert payment in progress */
    .alert-payment-in-progress {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 8px;
      padding: 8px 10px;
      background: hsl(38, 95%, 95%);
      border: 1px solid hsl(38, 95%, 75%);
      border-radius: 6px;
      color: hsl(38, 80%, 35%);
      font-size: 0.75rem;
      font-weight: 500;
    }

    .alert-payment-in-progress svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      stroke: hsl(38, 90%, 45%);
    }

    /* Tipo Midia Colors */
    .tipo-midia {
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.85em;
      display: inline-block;
      margin-bottom: 2px;
    }
    
    .tipo-midia-tv { background: hsl(142, 40%, 93%); color: hsl(142, 60%, 30%); }
    .tipo-midia-radio { background: hsl(30, 80%, 93%); color: hsl(30, 70%, 35%); }
    .tipo-midia-internet { background: hsl(217, 80%, 93%); color: hsl(217, 70%, 40%); }
    .tipo-midia-impressos { background: hsl(340, 60%, 93%); color: hsl(340, 50%, 40%); }
    .tipo-midia-exterior { background: hsl(270, 50%, 93%); color: hsl(270, 50%, 40%); }
    .tipo-midia-producao { background: hsl(30, 30%, 93%); color: hsl(30, 30%, 35%); }
    .tipo-midia-comunitarios { background: hsl(175, 50%, 93%); color: hsl(175, 50%, 30%); }
    
    /* Executor Date Selector */
    .executor-date-select {
      margin-left: auto;
      padding-left: 16px;
    }
    
    .multi-select-executor {
      position: relative;
      min-width: 280px;
    }
    
    .multi-select-trigger-executor {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: hsl(220, 20%, 97%);
      border: 1px solid hsl(220, 15%, 85%);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.8rem;
      color: hsl(220, 25%, 25%);
      transition: all 0.15s;
    }
    
    .multi-select-trigger-executor:hover {
      border-color: hsl(252, 85%, 60%);
    }
    
    .multi-select-trigger-executor.open {
      border-color: hsl(252, 85%, 60%);
      box-shadow: 0 0 0 3px hsla(252, 85%, 60%, 0.15);
    }
    
    .multi-select-arrow-executor {
      width: 14px;
      height: 14px;
      transition: transform 0.2s;
      margin-left: 8px;
    }
    
    .multi-select-trigger-executor.open .multi-select-arrow-executor {
      transform: rotate(180deg);
    }
    
    .multi-select-dropdown-executor {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: white;
      border: 1px solid hsl(220, 15%, 85%);
      border-radius: 8px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      z-index: 100;
      max-height: 280px;
      overflow-y: auto;
      display: none;
    }
    
    .multi-select-dropdown-executor.open {
      display: block;
    }
    
    .multi-select-option-executor {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: background 0.1s;
    }
    
    .multi-select-option-executor:hover {
      background: hsl(220, 20%, 97%);
    }
    
    .multi-select-option-executor.selected {
      background: hsl(252, 85%, 97%);
    }
    
    .multi-select-checkbox-executor {
      width: 16px;
      height: 16px;
      border: 2px solid hsl(220, 15%, 75%);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    
    .multi-select-option-executor.selected .multi-select-checkbox-executor {
      background: hsl(252, 85%, 55%);
      border-color: hsl(252, 85%, 55%);
    }
    
    .multi-select-checkmark-executor {
      display: none;
      width: 10px;
      height: 10px;
    }
    
    .multi-select-option-executor.selected .multi-select-checkmark-executor {
      display: block;
    }
    
    /* Executor Table Styles */
    .executor-table-wrapper {
      overflow-x: auto;
    }
    
    .executor-count {
      background: hsl(220, 15%, 96%);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      color: hsl(220, 10%, 50%);
      display: inline-block;
      margin-bottom: 12px;
    }
    
    .executor-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    .executor-table th {
      text-align: left;
      padding: 12px 16px;
      background: hsl(220, 20%, 97%);
      font-weight: 600;
      font-size: 0.75rem;
      letter-spacing: 0.3px;
      color: hsl(220, 10%, 50%);
      border-bottom: 2px solid hsl(220, 15%, 92%);
    }
    
    .executor-table th.center {
      text-align: center;
    }
    
    .executor-table td {
      padding: 14px 16px;
      border-bottom: 1px solid hsl(220, 15%, 95%);
      vertical-align: middle;
    }
    
    .executor-table tr:hover td {
      background: hsl(220, 20%, 98%);
    }
    
    .executor-table tr:last-child td {
      border-bottom: none;
    }
    
    .executor-table .executor-name {
      font-weight: 600;
      color: hsl(220, 15%, 30%);
    }
    
    .executor-table .count {
      text-align: center;
      font-weight: 600;
    }
    
    .executor-table .count.av {
      color: hsl(252, 85%, 55%);
    }
    
    .executor-table .count.calia {
      color: hsl(30, 90%, 50%);
    }
    
    .executor-table .count.ebm {
      color: hsl(220, 10%, 50%);
    }
    
    .executor-table .count.total {
      color: hsl(220, 25%, 25%);
      font-weight: 400;
    }
    
    .executor-table .valor {
      font-weight: 400;
      color: hsl(142, 70%, 40%);
      white-space: nowrap;
      text-align: center;
      min-width: 120px;
    }
    
    .executor-table .nfs-cell {
      font-size: 0.7rem;
      line-height: 1.4;
      min-width: 150px;
      text-align: justify;
    }
    
    .executor-table .nfs-group {
      margin-bottom: 4px;
    }
    
    .executor-table .nfs-group:last-child {
      margin-bottom: 0;
    }
    
    .executor-table .nfs-agencia {
      font-weight: 600;
      display: inline;
      margin-right: 4px;
    }
    
    .executor-table .nfs-agencia.av {
      color: hsl(252, 85%, 55%);
    }
    
    .executor-table .nfs-agencia.calia {
      color: hsl(30, 90%, 50%);
    }
    
    .executor-table .nfs-agencia.ebm {
      color: hsl(220, 10%, 50%);
    }
    
    .executor-table .nfs-lista {
      color: hsl(220, 15%, 40%);
      font-size: 0.65rem;
      display: inline;
    }
    
    .executor-table .summary-row {
      background: hsl(220, 20%, 97%) !important;
      font-weight: 700;
    }
    
    .executor-table .summary-row td {
      border-top: 2px solid hsl(220, 15%, 90%);
      padding-top: 16px;
    }
    
    .executor-table .summary-row:hover td {
      background: hsl(220, 20%, 97%) !important;
    }
  </style>
</head>

<body>

  <script>
    // Define onIframeLoad early so it's available when iframe loads
    function onIframeLoad(type) {
      var loading = document.getElementById(type + 'Loading');
      var iframe = document.getElementById(type + 'Iframe');
      if (loading) loading.style.display = 'none';
      if (iframe) iframe.style.display = 'block';
    }
  </script>

  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p class="loading-text">Carregando dados...</p>
  </div>

  <div id="error"></div>
  <div id="diagnostico"></div>

  <div class="container">
    
    <!-- Header -->
    <div class="header">
      <div class="header-badge">
        <svg class="header-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h1>Planejamento e acompanhamento de pagamentos</h1>
      </div>
    </div>

    <!-- Cards Container -->
    <div class="cards-row">
      <!-- Gerar Tabela de Controle -->
      <div class="link-card" id="geradorCard" onclick="toggleGerador()">
        <div class="link-card-header">
          <div class="link-card-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
          </div>
          <h2 class="link-card-title">Gerar Tabela de Controle de Pagamento</h2>
        </div>
        
        <div class="link-card-content" id="geradorContent" onclick="event.stopPropagation()">
          <div class="iframe-container">
            <div class="iframe-loading" id="geradorLoading">
              <div class="spinner" style="width: 32px; height: 32px;"></div>
              <span style="margin-left: 12px; color: hsl(220, 15%, 50%);">Carregando...</span>
            </div>
            <iframe id="geradorIframe" src="" title="Controle de Pagamento" style="display: none;" onload="onIframeLoad('gerador')"></iframe>
          </div>
        </div>
      </div>

      <!-- Divisão de Notas por Executor -->
      <div class="link-card" id="divisaoCard">
        <div class="link-card-header" onclick="toggleDivisao()">
          <div class="link-card-icon" style="background: hsl(252, 85%, 92%); color: hsl(252, 85%, 55%);">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="9" cy="7" r="4"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M16 3.13a4 4 0 0 1 0 7.75"/>
              <path stroke-linecap="round" stroke-linejoin="round" d="M21 21v-2a4 4 0 0 0-3-3.85"/>
            </svg>
          </div>
          <h2 class="link-card-title">Divisão de Notas por Executor</h2>
          
          <!-- Date Selector - Always visible -->
          <div class="executor-date-select" onclick="event.stopPropagation()">
            <div class="multi-select-executor" id="executorMultiSelect">
              <div class="multi-select-trigger-executor" id="executorSelectTrigger" onclick="toggleExecutorDropdown(event)">
                <span id="executorSelectLabel">Carregando...</span>
                <svg class="multi-select-arrow-executor" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
              </div>
              <div class="multi-select-dropdown-executor" id="executorSelectDropdown"></div>
            </div>
          </div>
        </div>
        
        <div class="link-card-content" id="divisaoContent">
          <div class="executor-table-wrapper">
            <div class="executor-count" id="executorCount">0 executores</div>
            <table class="executor-table">
              <thead>
                <tr>
                  <th>Executor</th>
                  <th class="center">AV</th>
                  <th class="center">Calia</th>
                  <th class="center">EBM</th>
                  <th class="center">NFs</th>
                  <th class="center">Em análise</th>
                  <th class="center">Analisadas</th>
                  <th class="center">Total</th>
                  <th class="center">Valor total</th>
                </tr>
              </thead>
              <tbody id="executorTableBody">
                <tr>
                  <td colspan="9">
                    <div class="empty-state">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                      <p>Selecione uma ou mais datas para ver os dados</p>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Em Processo de Pagamento -->
    <div class="section processo">
      <div class="section-header">
        <div class="section-title">
          <span class="dot"></span>
          Em Processo de Pagamento
        </div>
        <div class="section-count">
          <span class="count-badge gray" id="count-processo">0 processo(s)</span>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Agência</th>
              <th>Campanha</th>
              <th>Controle</th>
              <th>Qtd Notas</th>
              <th>Valor Total</th>
              <th>Data Atesto</th>
              <th>Status</th>
              <th>Observação</th>
            </tr>
          </thead>
          <tbody id="tbody-processo">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Notas Atestadas -->
    <div class="section atestadas">
      <div class="section-header">
        <div class="section-title">
          <span class="dot"></span>
          Notas em análise, Atestadas ou com inconformidade
        </div>
        <div class="section-count" id="count-atestadas">
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Agência</th>
              <th>Campanha</th>
              <th>Qtd Notas</th>
              <th>Valor Total</th>
              <th>Inconformidades</th>
              <th>Observação</th>
            </tr>
          </thead>
          <tbody id="tbody-atestadas">
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pagas -->
    <div class="section pagas">
      <div class="section-header">
        <div class="section-title">
          <span class="dot"></span>
          Pagas (Último Mês)
        </div>
        <div class="section-count">
          <span class="count-badge gray" id="count-pagas">0 processo(s)</span>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Agência</th>
              <th>Campanha</th>
              <th>Controle</th>
              <th>Qtd Notas</th>
              <th>Valor Total</th>
              <th>Data Pagamento</th>
            </tr>
          </thead>
          <tbody id="tbody-pagas">
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // Toggle Gerador Card
    var geradorExpanded = false;
    var geradorLoaded = false;
    function toggleGerador() {
      var card = document.getElementById('geradorCard');
      var content = document.getElementById('geradorContent');
      var iframe = document.getElementById('geradorIframe');
      
      if (geradorExpanded) {
        geradorExpanded = false;
        card.classList.remove('expanded');
        content.classList.remove('show');
      } else {
        geradorExpanded = true;
        card.classList.add('expanded');
        content.classList.add('show');
        
        // Load iframe only once
        if (!geradorLoaded) {
          iframe.src = 'https://script.google.com/macros/s/AKfycbwbtE9CMU_odeT-lPUkzQn4nyPzbBTk1YnnPR1t_9F6SE-k42Y33tERxmYKNC5hWFmE/exec';
          geradorLoaded = true;
        }
      }
    }

    // Toggle Divisão Card
    var divisaoExpanded = false;
    var executorDropdownOpen = false;
    var executorDatasDisponiveis = [];
    var executorDatasSelecionadas = [];
    var executorDadosCarregados = {};
    var executorCarregandoDatas = {};
    
    function toggleDivisao() {
      var card = document.getElementById('divisaoCard');
      var content = document.getElementById('divisaoContent');
      
      if (divisaoExpanded) {
        divisaoExpanded = false;
        card.classList.remove('expanded');
        content.classList.remove('show');
      } else {
        divisaoExpanded = true;
        card.classList.add('expanded');
        content.classList.add('show');
      }
    }
    
    function toggleExecutorDropdown(e) {
      e.stopPropagation();
      executorDropdownOpen = !executorDropdownOpen;
      document.getElementById('executorSelectTrigger').classList.toggle('open', executorDropdownOpen);
      document.getElementById('executorSelectDropdown').classList.toggle('open', executorDropdownOpen);
    }
    
    function updateExecutorSelectLabel() {
      var label = document.getElementById('executorSelectLabel');
      if (executorDatasSelecionadas.length === 0) {
        label.innerHTML = 'Clique para selecionar datas';
      } else {
        label.innerHTML = executorDatasSelecionadas.map(function(d) { return formatExecutorDate(d); }).join(', ');
      }
    }
    
    function formatExecutorDate(dateStr) {
      if (!dateStr) return '-';
      var parts = dateStr.split('-');
      if (parts.length !== 3) return dateStr;
      return parts[2] + '/' + parts[1] + '/' + parts[0];
    }
    
    function renderExecutorDropdownOptions() {
      var container = document.getElementById('executorSelectDropdown');
      if (executorDatasDisponiveis.length === 0) {
        container.innerHTML = '<div style="padding: 16px; text-align: center; color: hsl(220, 10%, 60%);">Nenhuma data disponível</div>';
        return;
      }
      container.innerHTML = executorDatasDisponiveis.map(function(date) {
        var isSelected = executorDatasSelecionadas.includes(date);
        return '<div class="multi-select-option-executor' + (isSelected ? ' selected' : '') + '" onclick="toggleExecutorDate(\'' + date + '\'); event.stopPropagation();">' +
          '<div class="multi-select-checkbox-executor">' +
          '<svg class="multi-select-checkmark-executor" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M5 12l5 5L20 7"/></svg>' +
          '</div><span>' + formatExecutorDate(date) + '</span></div>';
      }).join('');
    }
    
    function toggleExecutorDate(dateValue) {
      if (executorDatasSelecionadas.includes(dateValue)) {
        executorDatasSelecionadas = executorDatasSelecionadas.filter(function(d) { return d !== dateValue; });
        renderExecutorDropdownOptions();
        updateExecutorSelectLabel();
        atualizarExecutorTabela();
      } else {
        executorDatasSelecionadas.push(dateValue);
        renderExecutorDropdownOptions();
        updateExecutorSelectLabel();
        if (!executorDadosCarregados[dateValue] && !executorCarregandoDatas[dateValue]) {
          carregarExecutorDadosParaData(dateValue);
        } else {
          atualizarExecutorTabela();
        }
      }
      
      // Auto-expand if not expanded and date selected
      if (!divisaoExpanded && executorDatasSelecionadas.length > 0) {
        toggleDivisao();
      }
    }
    
    function carregarExecutorDadosParaData(data) {
      executorCarregandoDatas[data] = true;
      showLoading(true);
      
      google.script.run
        .withSuccessHandler(function(result) {
          delete executorCarregandoDatas[data];
          executorDadosCarregados[data] = result;
          if (Object.keys(executorCarregandoDatas).length === 0) {
            showLoading(false);
          }
          atualizarExecutorTabela();
        })
        .withFailureHandler(function(error) {
          delete executorCarregandoDatas[data];
          if (Object.keys(executorCarregandoDatas).length === 0) {
            showLoading(false);
          }
          showError('Erro ao carregar dados: ' + error.message);
        })
        .getDadosExecutores(data);
    }
    
    function atualizarExecutorTabela() {
      var tbody = document.getElementById('executorTableBody');
      if (executorDatasSelecionadas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><p>Selecione datas no menu acima para ver os dados</p></div></td></tr>';
        document.getElementById('executorCount').textContent = '0 executores';
        return;
      }
      
      var executoresAgregados = {};
      executorDatasSelecionadas.forEach(function(data) {
        var result = executorDadosCarregados[data];
        if (!result || !result.executores) return;
        result.executores.forEach(function(exec) {
          var nome = exec.nome;
          if (!executoresAgregados[nome]) {
            executoresAgregados[nome] = { nome: nome, av: 0, calia: 0, ebm: 0, total: 0, emAnalise: 0, valor: 0, nfsAv: [], nfsCalia: [], nfsEbm: [] };
          }
          executoresAgregados[nome].av += exec.av || 0;
          executoresAgregados[nome].calia += exec.calia || 0;
          executoresAgregados[nome].ebm += exec.ebm || 0;
          executoresAgregados[nome].total += exec.total || 0;
          executoresAgregados[nome].emAnalise += exec.emAnalise || 0;
          executoresAgregados[nome].valor += exec.valor || 0;
          if (exec.nfsAv && exec.nfsAv.length > 0) { executoresAgregados[nome].nfsAv = executoresAgregados[nome].nfsAv.concat(exec.nfsAv); }
          if (exec.nfsCalia && exec.nfsCalia.length > 0) { executoresAgregados[nome].nfsCalia = executoresAgregados[nome].nfsCalia.concat(exec.nfsCalia); }
          if (exec.nfsEbm && exec.nfsEbm.length > 0) { executoresAgregados[nome].nfsEbm = executoresAgregados[nome].nfsEbm.concat(exec.nfsEbm); }
        });
      });
      
      var executores = Object.values(executoresAgregados).sort(function(a, b) { return a.nome.localeCompare(b.nome); });
      document.getElementById('executorCount').textContent = executores.length + ' executor' + (executores.length !== 1 ? 'es' : '');
      
      if (executores.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg><p>Nenhuma nota encontrada</p></div></td></tr>';
        return;
      }
      
      var total = { av: 0, calia: 0, ebm: 0, total: 0, emAnalise: 0, valor: 0 };
      var html = executores.map(function(exec) {
        var analisadas = exec.total - exec.emAnalise;
        total.av += exec.av;
        total.calia += exec.calia;
        total.ebm += exec.ebm;
        total.total += exec.total;
        total.emAnalise += exec.emAnalise;
        total.valor += exec.valor;
        
        var nfsHtml = '';
        if (exec.nfsAv && exec.nfsAv.length > 0) { nfsHtml += '<div class="nfs-group"><span class="nfs-agencia av">AV:</span> <span class="nfs-lista">' + exec.nfsAv.join(', ') + '</span></div>'; }
        if (exec.nfsCalia && exec.nfsCalia.length > 0) { nfsHtml += '<div class="nfs-group"><span class="nfs-agencia calia">Calia:</span> <span class="nfs-lista">' + exec.nfsCalia.join(', ') + '</span></div>'; }
        if (exec.nfsEbm && exec.nfsEbm.length > 0) { nfsHtml += '<div class="nfs-group"><span class="nfs-agencia ebm">EBM:</span> <span class="nfs-lista">' + exec.nfsEbm.join(', ') + '</span></div>'; }
        if (!nfsHtml) nfsHtml = '-';
        
        return '<tr>' +
          '<td class="executor-name">' + exec.nome + '</td>' +
          '<td class="count av">' + exec.av + '</td>' +
          '<td class="count calia">' + exec.calia + '</td>' +
          '<td class="count ebm">' + exec.ebm + '</td>' +
          '<td class="nfs-cell">' + nfsHtml + '</td>' +
          '<td class="count total">' + exec.emAnalise + '</td>' +
          '<td class="count total">' + analisadas + '</td>' +
          '<td class="count total">' + exec.total + '</td>' +
          '<td class="count total">' + formatCurrency(exec.valor) + '</td>' +
        '</tr>';
      }).join('');
      
      var totalAnalisadas = total.total - total.emAnalise;
      html += '<tr class="summary-row">' +
        '<td><strong>TOTAL</strong></td>' +
        '<td class="count av">' + total.av + '</td>' +
        '<td class="count calia">' + total.calia + '</td>' +
        '<td class="count ebm">' + total.ebm + '</td>' +
        '<td class="nfs-cell">-</td>' +
        '<td class="count total">' + total.emAnalise + '</td>' +
        '<td class="count total">' + totalAnalisadas + '</td>' +
        '<td class="count total">' + total.total + '</td>' +
        '<td class="count total">' + formatCurrency(total.valor) + '</td>' +
      '</tr>';
      
      tbody.innerHTML = html;
    }
    
    function carregarExecutorDatasDisponiveis() {
      if (!window.google || !google.script || !google.script.run) {
        document.getElementById('executorSelectLabel').textContent = 'Sem conexão';
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.datasDisponiveis) {
            executorDatasDisponiveis = result.datasDisponiveis;
            if (executorDatasDisponiveis.length > 0) {
              var dataMaisRecente = executorDatasDisponiveis[0];
              executorDatasSelecionadas.push(dataMaisRecente);
              executorDadosCarregados[dataMaisRecente] = result;
            } else {
              // Sem datas disponíveis - mostrar diagnóstico
              carregarDiagnosticoExecutores();
            }
            renderExecutorDropdownOptions();
            updateExecutorSelectLabel();
            atualizarExecutorTabela();
          } else {
            // Resultado vazio - mostrar diagnóstico
            carregarDiagnosticoExecutores();
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('executorSelectLabel').textContent = 'Erro ao carregar';
          carregarDiagnosticoExecutores();
        })
        .getDadosExecutores('');
    }
    
    function carregarDiagnosticoExecutores() {
      if (!window.google || !google.script || !google.script.run) return;
      
      google.script.run
        .withSuccessHandler(function(diag) {
          showDiagnosticoExecutores(diag);
        })
        .withFailureHandler(function(error) {
          console.error('Erro ao carregar diagnóstico:', error);
        })
        .getDiagnosticoExecutores();
    }
    
    function showDiagnosticoExecutores(diag) {
      var el = document.getElementById('diagnostico');
      if (!el) return;
      
      if (!diag) {
        el.innerHTML = '';
        el.classList.remove('show');
        return;
      }
      
      try {
        el.innerHTML = '';
        
        var title = document.createElement('div');
        title.className = 'diag-title';
        title.textContent = 'Diagnóstico de Executores (dados vazios detectados)';
        title.style.cssText = 'font-weight: 600; margin-bottom: 12px; color: hsl(38, 95%, 45%);';
        
        var dica = document.createElement('div');
        dica.style.cssText = 'padding: 12px; background: ' + (diag.dica && diag.dica.indexOf('PROBLEMA') > -1 ? 'hsl(0, 75%, 95%)' : 'hsl(142, 50%, 95%)') + '; border-radius: 8px; margin-bottom: 12px; font-weight: 500;';
        dica.textContent = diag.dica || '';
        
        var pre = document.createElement('pre');
        pre.style.cssText = 'background: hsl(220, 15%, 97%); padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 0.75rem;';
        pre.textContent = JSON.stringify(diag, null, 2);
        
        el.appendChild(title);
        el.appendChild(dica);
        el.appendChild(pre);
        el.classList.add('show');
      } catch (e) {
        el.innerHTML = '<pre>Erro ao exibir diagnóstico: ' + e.message + '</pre>';
        el.classList.add('show');
      }
    }
    
    // Close executor dropdown when clicking outside
    document.addEventListener('click', function(e) {
      var multiSelect = document.getElementById('executorMultiSelect');
      if (executorDropdownOpen && multiSelect && !multiSelect.contains(e.target)) {
        executorDropdownOpen = false;
        document.getElementById('executorSelectTrigger').classList.remove('open');
        document.getElementById('executorSelectDropdown').classList.remove('open');
      }
    });

    // Original pagamentos.html JavaScript
    var dados = { emProcesso: [], atestadas: [], pagas: [] };
    
    var DIAS_SEMANA = ['Domingo', 'Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado'];
    
    var STATUS_OPTIONS = [
      { value: 'montando', label: 'Montando' },
      { value: 'aguardando', label: 'Aguardando Assinaturas' },
      { value: 'dicom', label: 'DICOM' },
      { value: 'daf', label: 'DAF' },
      { value: 'ob', label: 'OB' },
      { value: 'enviado', label: 'Controle Retenções Enviado' }
    ];
    
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('show', show);
    }
    
    function showError(msg) {
      var el = document.getElementById('error');
      el.textContent = msg;
      el.classList.toggle('show', !!msg);
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    function showDiagnostico(diag) {
      var el = document.getElementById('diagnostico');
      if (!el) return;

      if (!diag) {
        el.innerHTML = '';
        el.classList.remove('show');
        return;
      }

      try {
        el.innerHTML = '';

        var title = document.createElement('div');
        title.className = 'diag-title';
        title.textContent = 'Diagnóstico (para encontrar colunas/aba erradas)';

        var pre = document.createElement('pre');
        pre.textContent = JSON.stringify(diag, null, 2);

        el.appendChild(title);
        el.appendChild(pre);
        el.classList.add('show');
      } catch (e) {
        el.innerHTML = '';
        var preFallback = document.createElement('pre');
        preFallback.textContent = 'Falha ao renderizar diagnóstico: ' + (e && e.message ? e.message : String(e));
        el.appendChild(preFallback);
        el.classList.add('show');
      }
    }

    function formatCurrency(value) {
      return 'R$ ' + (value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    function formatDate(date) {
      if (!date) return '-';
      var d = new Date(date);
      if (isNaN(d)) return '-';
      var dia = String(d.getDate()).padStart(2, '0');
      var mes = String(d.getMonth() + 1).padStart(2, '0');
      var ano = d.getFullYear();
      var diaSemana = DIAS_SEMANA[d.getDay()];
      
      var hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      var dataComp = new Date(d);
      dataComp.setHours(0, 0, 0, 0);
      var diffMs = hoje - dataComp;
      var diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      
      var agoText = '';
      if (diffDias === 0) {
        agoText = 'hoje';
      } else if (diffDias === 1) {
        agoText = 'há 1 dia';
      } else if (diffDias > 1) {
        agoText = 'há ' + diffDias + ' dias';
      }
      
      return '<span>' + dia + '/' + mes + '/' + ano + '</span><span class="data-dia">' + diaSemana + (agoText ? ' · ' + agoText : '') + '</span>';
    }
    
    function createStatusSelect(currentStatus, key) {
      var html = '<select class="status-select ' + currentStatus + '" onchange="updateStatus(\'' + key + '\', this.value)">';
      STATUS_OPTIONS.forEach(function(opt) {
        var selected = opt.value === currentStatus ? 'selected' : '';
        html += '<option value="' + opt.value + '" ' + selected + '>' + opt.label + '</option>';
      });
      html += '</select>';
      return html;
    }
    
    function updateStatus(key, newStatus) {
      var select = event.target;
      select.className = 'status-select ' + newStatus;
      saveField('emProcesso', key, 'statusPag', newStatus);
    }
    
    function saveObs(section, key, value) {
      saveField(section, key, 'obs', value);
    }
    
    function saveField(section, key, field, value) {
      var items = dados[section] || [];
      var parts = key.split('|');
      
      for (var i = 0; i < items.length; i++) {
        var item = items[i];
        var itemKey = '';
        
        if (section === 'emProcesso' || section === 'pagas') {
          itemKey = (item.agencia || '') + '|' + (item.campanha || '') + '|' + (item.controle || '');
        } else {
          itemKey = (item.agencia || '') + '|' + (item.campanha || '');
        }
        
        if (itemKey === key) {
          item[field] = value;
          break;
        }
      }
      
      if (window.google && google.script && google.script.run) {
        google.script.run
          .withSuccessHandler(function() {})
          .withFailureHandler(function(err) {
            console.error('Erro ao salvar:', err);
          })
          .saveField(section, key, field, value);
      }
    }
    
    function renderEmProcesso() {
      var tbody = document.getElementById('tbody-processo');
      var count = document.getElementById('count-processo');
      var items = dados.emProcesso || [];
      
      count.textContent = items.length + ' processo(s)';
      
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 13h6M9 17h4"/></svg><p>Nenhum pagamento em processo</p></div></td></tr>';
        return;
      }
      
      var totalValor = 0;
      var totalQtd = 0;
      
      var html = items.map(function(item, idx) {
        var key = item.agencia + '|' + item.campanha + '|' + item.controle;
        totalValor += item.valor;
        totalQtd += item.qtd;
        
        return '<tr>' +
          '<td class="agencia">' + (item.agencia || '-') + '</td>' +
          '<td class="campanha">' + (item.campanha || '-') + '</td>' +
          '<td><span class="controle">' + (item.controle || '-') + '</span></td>' +
          '<td class="qtd">' + item.qtd + '</td>' +
          '<td class="valor">' + formatCurrency(item.valor) + '</td>' +
          '<td class="data">' + formatDate(item.dataAtesto) + '</td>' +
          '<td>' + createStatusSelect(item.statusPag || 'montando', key) + '</td>' +
          '<td><input type="text" class="obs-input" style="min-width: 200px;" placeholder="Observação..." value="' + escapeHtml(item.obs || '') + '" onchange="saveObs(\'emProcesso\', \'' + escapeHtml(key) + '\', this.value)"></td>' +
        '</tr>';
      }).join('');
      
      html += '<tr class="summary-row">' +
        '<td><strong>Total</strong></td>' +
        '<td></td>' +
        '<td></td>' +
        '<td class="qtd"><strong>' + totalQtd + '</strong></td>' +
        '<td class="valor"><strong>' + formatCurrency(totalValor) + '</strong></td>' +
        '<td></td>' +
        '<td></td>' +
        '<td></td>' +
      '</tr>';
      
      tbody.innerHTML = html;
    }
    
    function renderAtestadas() {
      var tbody = document.getElementById('tbody-atestadas');
      var countEl = document.getElementById('count-atestadas');
      var items = dados.atestadas || [];
      var emProcessoItems = dados.emProcesso || [];
      
      var emProcessoKeys = {};
      emProcessoItems.forEach(function(item) {
        var key = (item.agencia || '') + '|' + (item.campanha || '');
        emProcessoKeys[key] = true;
      });
      
      var totalEmAnalise = 0;
      var totalAtestadas = 0;
      var totalPendentes = 0;
      
      items.forEach(function(item) {
        totalEmAnalise += item.qtdEmAnalise || 0;
        totalAtestadas += item.qtdAtestada || 0;
        totalPendentes += item.qtdPendente || 0;
      });
      
      var countHtml = '';
      if (totalEmAnalise > 0) {
        countHtml += '<span class="count-badge gray">' + totalEmAnalise + ' em análise</span>';
      }
      countHtml += '<span class="count-badge blue">' + totalAtestadas + ' atestadas</span>';
      if (totalPendentes > 0) {
        countHtml += '<span class="count-badge red">' + totalPendentes + ' inconformidades</span>';
      }
      countEl.innerHTML = countHtml;
      
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 12l2 2 4-4"/><circle cx="12" cy="12" r="10"/></svg><p>Nenhuma nota atestada pendente</p></div></td></tr>';
        return;
      }
      
      var totalValorEmAnalise = 0;
      var totalValorAtestado = 0;
      var totalValorPendente = 0;
      var totalQtdEmAnalise = 0;
      var totalQtdAtestada = 0;
      var totalQtdPendente = 0;
      
      var html = items.map(function(item) {
        var key = (item.agencia || '') + '|' + (item.campanha || '');
        totalValorEmAnalise += item.valorEmAnalise || 0;
        totalValorAtestado += item.valorAtestado || 0;
        totalValorPendente += item.valorPendente || 0;
        totalQtdEmAnalise += item.qtdEmAnalise || 0;
        totalQtdAtestada += item.qtdAtestada || 0;
        totalQtdPendente += item.qtdPendente || 0;
        
        var hasPaymentInProgress = emProcessoKeys[key] === true;
        
        var pendentesHtml = '-';
        if (item.pendentes && item.pendentes.length > 0) {
          pendentesHtml = item.pendentes.map(function(p) {
            var valorStr = p.valor ? ' | ' + formatCurrency(p.valor) : '';
            var tipoMidiaClass = 'tipo-midia';
            var tipoMidiaLower = (p.tipoMidia || '').toLowerCase();
            if (tipoMidiaLower.indexOf('tv') > -1) {
              tipoMidiaClass += ' tipo-midia-tv';
            } else if (tipoMidiaLower.indexOf('rádio') > -1 || tipoMidiaLower.indexOf('radio') > -1) {
              tipoMidiaClass += ' tipo-midia-radio';
            } else if (tipoMidiaLower.indexOf('internet') > -1) {
              tipoMidiaClass += ' tipo-midia-internet';
            } else if (tipoMidiaLower.indexOf('impresso') > -1) {
              tipoMidiaClass += ' tipo-midia-impressos';
            } else if (tipoMidiaLower.indexOf('exterior') > -1) {
              tipoMidiaClass += ' tipo-midia-exterior';
            } else if (tipoMidiaLower.indexOf('produção') > -1 || tipoMidiaLower.indexOf('producao') > -1) {
              tipoMidiaClass += ' tipo-midia-producao';
            } else if (tipoMidiaLower.indexOf('comunitário') > -1 || tipoMidiaLower.indexOf('comunitario') > -1) {
              tipoMidiaClass += ' tipo-midia-comunitarios';
            }
            var tipoMidiaHtml = p.tipoMidia ? '<span class="' + tipoMidiaClass + '">' + escapeHtml(p.tipoMidia) + '</span><br>' : '';
            return '<div class="pendente-item">' +
              tipoMidiaHtml +
              '<span class="pendente-info">NF: ' + (p.nf || '-') + ' | ' + (p.veiculo || '-') + ' | ' + (p.executor || '-') + valorStr + '</span>' +
            '</div>';
          }).join('');
        }
        
        var qtdEmAnalise = item.qtdEmAnalise || 0;
        var qtdAtestada = item.qtdAtestada || 0;
        var qtdPendente = item.qtdPendente || 0;
        var qtdDiligencia = item.qtdDiligencia || 0;
        var qtdTotal = qtdEmAnalise + qtdAtestada + qtdPendente + qtdDiligencia;
        var qtdHtml = '<div>' + qtdTotal + '</div>';
        qtdHtml += '<div class="qtd-sub" style="color: hsl(220, 10%, 50%);">';
        qtdHtml += '<div>' + qtdEmAnalise + ' em análise</div>';
        qtdHtml += '<div>' + qtdAtestada + ' atestadas</div>';
        qtdHtml += '<div>' + (qtdPendente + qtdDiligencia) + ' inconform.</div>';
        qtdHtml += '</div>';
        
        var valorEmAnalise = item.valorEmAnalise || 0;
        var valorAtestado = item.valorAtestado || 0;
        var valorPendente = item.valorPendente || 0;
        var valorDiligencia = item.valorDiligencia || 0;
        var valorTotal = valorEmAnalise + valorAtestado + valorPendente + valorDiligencia;
        var valorHtml = '<div>' + formatCurrency(valorTotal) + '</div>';
        valorHtml += '<div class="valor-sub" style="color: hsl(220, 10%, 50%);">';
        valorHtml += '<div>' + formatCurrency(valorEmAnalise) + ' em análise</div>';
        valorHtml += '<div>' + formatCurrency(valorAtestado) + ' atestadas</div>';
        valorHtml += '<div>' + formatCurrency(valorPendente + valorDiligencia) + ' inconform.</div>';
        valorHtml += '</div>';
        
        var obsHtml = '<input type="text" class="obs-input" style="min-width: 200px;" placeholder="Observação..." value="' + escapeHtml(item.obs || '') + '" onchange="saveObs(\'atestadas\', \'' + escapeHtml(key) + '\', this.value)">';
        if (hasPaymentInProgress) {
          obsHtml += '<div class="alert-payment-in-progress">' +
            '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>' +
            '<span>Há outro pagamento em andamento. Aguarde.</span>' +
          '</div>';
        }
        
        return '<tr>' +
          '<td class="agencia">' + (item.agencia || '-') + '</td>' +
          '<td class="campanha">' + (item.campanha || '-') + '</td>' +
          '<td class="qtd">' + qtdHtml + '</td>' +
          '<td class="valor">' + valorHtml + '</td>' +
          '<td class="pendentes-cell">' + pendentesHtml + '</td>' +
          '<td>' + obsHtml + '</td>' +
        '</tr>';
      }).join('');
      
      var totalQtdDiligencia = 0;
      var totalValorDiligencia = 0;
      items.forEach(function(item) {
        totalQtdDiligencia += item.qtdDiligencia || 0;
        totalValorDiligencia += item.valorDiligencia || 0;
      });
      
      var summaryQtdTotal = totalQtdEmAnalise + totalQtdAtestada + totalQtdPendente + totalQtdDiligencia;
      var summaryQtdHtml = '<strong>' + summaryQtdTotal + '</strong>';
      summaryQtdHtml += '<div class="qtd-sub" style="color: hsl(220, 10%, 50%);">';
      summaryQtdHtml += '<div>' + totalQtdEmAnalise + ' em análise</div>';
      summaryQtdHtml += '<div>' + totalQtdAtestada + ' atestadas</div>';
      summaryQtdHtml += '<div>' + (totalQtdPendente + totalQtdDiligencia) + ' inconform.</div>';
      summaryQtdHtml += '</div>';
      
      var summaryValorTotal = totalValorEmAnalise + totalValorAtestado + totalValorPendente + totalValorDiligencia;
      var summaryValorHtml = '<strong>' + formatCurrency(summaryValorTotal) + '</strong>';
      summaryValorHtml += '<div class="valor-sub" style="color: hsl(220, 10%, 50%);">';
      summaryValorHtml += '<div>' + formatCurrency(totalValorEmAnalise) + ' em análise</div>';
      summaryValorHtml += '<div>' + formatCurrency(totalValorAtestado) + ' atestadas</div>';
      summaryValorHtml += '<div>' + formatCurrency(totalValorPendente + totalValorDiligencia) + ' inconform.</div>';
      summaryValorHtml += '</div>';
      
      html += '<tr class="summary-row">' +
        '<td colspan="2"><strong>Total</strong></td>' +
        '<td class="qtd">' + summaryQtdHtml + '</td>' +
        '<td class="valor">' + summaryValorHtml + '</td>' +
        '<td colspan="2"></td>' +
      '</tr>';
      
      tbody.innerHTML = html;
    }
    
    function renderPagas() {
      var tbody = document.getElementById('tbody-pagas');
      var count = document.getElementById('count-pagas');
      var items = dados.pagas || [];
      
      count.textContent = items.length + ' processo(s)';
      
      if (items.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><p>Nenhum pagamento recente</p></div></td></tr>';
        return;
      }
      
      var html = items.map(function(item) {
        return '<tr>' +
          '<td class="agencia">' + (item.agencia || '-') + '</td>' +
          '<td class="campanha">' + (item.campanha || '-') + '</td>' +
          '<td><span class="controle">' + (item.controle || '-') + '</span></td>' +
          '<td class="qtd">' + item.qtd + '</td>' +
          '<td class="valor">' + formatCurrency(item.valor) + '</td>' +
          '<td class="data">' + formatDate(item.dataPago) + '</td>' +
        '</tr>';
      }).join('');
      
      tbody.innerHTML = html;
    }
    
    function montarPagamento(key) {
      var parts = key.split('|');
      var agencia = parts[0];
      var campanha = parts[1];
      
      var idx = dados.atestadas.findIndex(function(item) {
        return item.agencia === agencia && item.campanha === campanha;
      });
      
      if (idx > -1) {
        var item = dados.atestadas.splice(idx, 1)[0];
        
        dados.emProcesso.push({
          agencia: item.agencia,
          campanha: item.campanha,
          controle: 'NOVO',
          qtd: item.qtdAtestada || 0,
          valor: item.valorAtestado || 0,
          dataAtesto: new Date(),
          obs: item.obs,
          statusPag: 'montando'
        });
        
        renderEmProcesso();
        renderAtestadas();
      }
    }
    
    function marcarPago(key) {
      var parts = key.split('|');
      var agencia = parts[0];
      var campanha = parts[1];
      var controle = parts[2];
      
      var idx = dados.emProcesso.findIndex(function(item) {
        return item.agencia === agencia && item.campanha === campanha && item.controle === controle;
      });
      
      if (idx > -1) {
        var item = dados.emProcesso.splice(idx, 1)[0];
        
        dados.pagas.unshift({
          agencia: item.agencia,
          campanha: item.campanha,
          controle: item.controle,
          qtd: item.qtd,
          valor: item.valor,
          dataPago: new Date(),
          notas: item.notas,
          obs: item.obs
        });
        
        renderEmProcesso();
        renderPagas();
      }
    }
    
    function retornarAtestadas(key) {
      var parts = key.split('|');
      var agencia = parts[0];
      var campanha = parts[1];
      var controle = parts[2];
      
      var idx = dados.emProcesso.findIndex(function(item) {
        return item.agencia === agencia && item.campanha === campanha && item.controle === controle;
      });
      
      if (idx > -1) {
        var item = dados.emProcesso.splice(idx, 1)[0];
        
        var existing = dados.atestadas.find(function(a) {
          return a.agencia === agencia && a.campanha === campanha;
        });
        
        if (existing) {
          existing.qtdAtestada = (existing.qtdAtestada || 0) + item.qtd;
          existing.valorAtestado = (existing.valorAtestado || 0) + item.valor;
        } else {
          dados.atestadas.push({
            agencia: item.agencia,
            campanha: item.campanha,
            qtdAtestada: item.qtd,
            valorAtestado: item.valor,
            qtdPendente: 0,
            valorPendente: 0,
            pendentes: [],
            obs: item.obs
          });
        }
        
        renderEmProcesso();
        renderAtestadas();
      }
    }
    
    function loadData() {
      showLoading(true);
      showError('');

      try {
        if (!window.google || !google.script || !google.script.run) {
          showLoading(false);
          showError('Este painel precisa ser aberto pela URL do Web App do Google Apps Script (google.script.run indisponível neste preview).');
          renderEmProcesso();
          renderAtestadas();
          renderPagas();
          return;
        }

        google.script.run
          .withSuccessHandler(function(result) {
            showLoading(false);
            dados = result || { emProcesso: [], atestadas: [], pagas: [] };

            // Verificar se houve erro no backend
            if (dados.erro) {
              showError('Erro no backend: ' + dados.erro);
              showDiagnostico({ erro: dados.erro, dica: 'Verifique os logs do Apps Script em Execuções.' });
              renderEmProcesso();
              renderAtestadas();
              renderPagas();
              return;
            }

            var z1 = (dados.emProcesso || []).length;
            var z2 = (dados.atestadas || []).length;
            var z3 = (dados.pagas || []).length;

            if (z1 === 0 && z2 === 0 && z3 === 0) {
              showError('Dados retornaram vazios. Carregando diagnóstico...');
              showDiagnostico({ info: 'Carregando diagnóstico… (chamando getDiagnostico)' });
              console.log('[DEBUG] Iniciando chamada getDiagnostico()');

              // Timeout de 30 segundos para diagnóstico (planilhas grandes podem demorar)
              var diagTimeout = setTimeout(function() {
                console.log('[DEBUG] Timeout atingido para getDiagnostico');
                showDiagnostico({ 
                  erro: 'Timeout: diagnóstico demorou mais de 30 segundos.',
                  dica: 'Verifique em Apps Script > Execuções se há erros ou se a função está rodando.'
                });
              }, 30000);

              try {
                google.script.run
                  .withSuccessHandler(function(diag) {
                    console.log('[DEBUG] getDiagnostico sucesso:', diag);
                    clearTimeout(diagTimeout);
                    showDiagnostico(diag || { erro: 'Diagnóstico retornou null/undefined' });
                  })
                  .withFailureHandler(function(err) {
                    console.log('[DEBUG] getDiagnostico falhou:', err);
                    clearTimeout(diagTimeout);
                    showDiagnostico({ 
                      erro: (err && err.message) ? err.message : String(err),
                      dica: 'A função getDiagnostico() falhou. Verifique os logs do Apps Script.'
                    });
                  })
                  .getDiagnostico();
                console.log('[DEBUG] Chamada getDiagnostico() iniciada');
              } catch (diagErr) {
                console.log('[DEBUG] Erro ao chamar getDiagnostico:', diagErr);
                clearTimeout(diagTimeout);
                showDiagnostico({ 
                  erro: 'Erro ao iniciar getDiagnostico: ' + (diagErr.message || String(diagErr))
                });
              }
            } else {
              showDiagnostico(null);
              showError('');
            }

            renderEmProcesso();
            renderAtestadas();
            renderPagas();
          })
          .withFailureHandler(function(err) {
            showLoading(false);
            showError('Erro ao carregar dados: ' + (err && err.message ? err.message : String(err)));
            showDiagnostico({ erro: (err && err.message) ? err.message : String(err), dica: 'A chamada getDados() falhou. Verifique os logs do Apps Script.' });
            renderEmProcesso();
            renderAtestadas();
            renderPagas();
          })
          .getDados();
      } catch (e) {
        showLoading(false);
        showError('Erro ao inicializar carregamento: ' + (e && e.message ? e.message : String(e)));
        renderEmProcesso();
        renderAtestadas();
        renderPagas();
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      renderEmProcesso();
      renderAtestadas();
      renderPagas();
      loadData();
      carregarExecutorDatasDisponiveis();
    });
  </script>

</body>
</html>

